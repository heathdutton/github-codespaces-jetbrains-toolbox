name: Release

on:
  push:
    tags:
      - '[0-9]*'

permissions:
  contents: write
  attestations: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@45b52564f44a4a311f3e621e74c7c97dd0c5696a # v4

      - name: Generate Gradle Wrapper
        run: gradle wrapper --gradle-version 8.10

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.version.outputs.VERSION }}\"/" build.gradle.kts

      - name: Build Plugin
        run: ./gradlew buildPlugin

      - name: Get plugin filename
        id: plugin
        run: |
          PLUGIN_FILE=$(ls build/distributions/*.zip | head -1)
          echo "FILE=$PLUGIN_FILE" >> $GITHUB_OUTPUT
          echo "NAME=$(basename $PLUGIN_FILE)" >> $GITHUB_OUTPUT

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@96b4a1ef7235a096b17240c259729fdd70c83d45 # v2
        with:
          subject-path: ${{ steps.plugin.outputs.FILE }}

      - name: Generate SHA256 checksum
        run: |
          cd build/distributions
          sha256sum *.zip > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: true
          files: |
            build/distributions/*.zip
            build/distributions/checksums.txt

  # Publish to JetBrains Marketplace (optional, requires JETBRAINS_TOKEN secret)
  publish:
    runs-on: ubuntu-latest
    needs: release
    if: ${{ !contains(github.ref, '-') }}  # Skip for pre-releases

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up JDK 21
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@45b52564f44a4a311f3e621e74c7c97dd0c5696a # v4

      - name: Generate Gradle Wrapper
        run: gradle wrapper --gradle-version 8.10

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update version in build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.version.outputs.VERSION }}\"/" build.gradle.kts

      - name: Build Plugin
        run: ./gradlew buildPlugin

      - name: Publish to JetBrains Marketplace
        if: ${{ env.JETBRAINS_TOKEN != '' }}
        env:
          JETBRAINS_TOKEN: ${{ secrets.JETBRAINS_TOKEN }}
        run: |
          echo "Marketplace publishing not yet configured"
          echo "To enable, add JETBRAINS_TOKEN secret and update this step"
          # ./gradlew publishPlugin
